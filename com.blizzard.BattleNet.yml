app-id: com.blizzard.BattleNet
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '23.08'
base: org.winehq.Wine
base-version: stable-23.08
command: BattleNetWrapper
# rename-desktop-file: com.blizzard.BattleNet.desktop
# rename-icon: BattleNet
finish-args:
  - --device=all
  - --filesystem=host:ro
  - --env=WINE_SIMULATE_WRITECOPY=1
  - --socket=pulseaudio
  - --socket=x11
  - --share=network
  - --share=ipc
  - --allow=multiarch
  - --filesystem=xdg-run/gamescope-0:ro # Required for Gamescope on Steam Deck
inherit-extensions:
  - org.winehq.Wine.gecko
  - org.winehq.Wine.mono
  - org.winehq.Wine.DLLs
add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version
modules:
  - name: BattleNet
    buildsystem: simple
    sources:
      - type: file
        path: Hello32.exe
      - type: file
        path: Hello64.exe
      - type: file
        url: https://www.battle.net/download/getInstallerForGame?os=win&version=LIVE&gameProgram=BATTLENET_APP
        sha256: 002f33fee7b8a159058368b7e93e492931c4ca72e90660bdb2691bcd62fedd3c
        dest-filename: BattleNetSetup.exe
      - type: script
        commands:
          - |
            # echo "Setting up Discord rich presence"
            # for i in {0..9}; do
            #   test -S $XDG_RUNTIME_DIR/discord-ipc-$i ||
            #     ln -sf {app/com.discordapp.Discord,$XDG_RUNTIME_DIR}/discord-ipc-$i;
            # done

            echo "Running wineboot --init"
            wineboot --init

            echo "Performing tweak(s)..."
            echo "Disable winemenubuilder.exe..."
            wine reg add "HKEY_CURRENT_USER\Software\Wine\DllOverrides" /v "winemenubuilder.exe" /d "" /f

            echo "Disable crash dialog..."
            wine reg add "HKEY_CURRENT_USER\Software\Wine\WineDbg" /v "ShowCrashDialog" /t "REG_DWORD" /d "00000000" /f

            echo "Launching BattleNetSetup.exe"
            wine /app/bin/BattleNetSetup.exe
        dest-filename: BattleNetWrapper
    build-commands:
      - |
        echo "Moving BattleNetSetup.exe to /app/bin"
        mv BattleNetSetup.exe /app/bin

        echo "Moving BattleNetWrapper to /app/bin"
        mv BattleNetWrapper /app/bin
